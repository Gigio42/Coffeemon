<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Teste de Jogo - Batalha</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      :root {
        --player1-color: #3498db; /* Blue */
        --player2-color: #e74c3c; /* Red */
        --bg-color: #2c3e50; /* Darker background */
        --card-bg-color: #ffffff;
        --disabled-color: #bdc3c7;
        --font-color: #333;
        --border-color: #e0e0e0; /* Lighter border */
        --log-bg-color: #e9ecef;
        --highlight-glow: #2ecc71; /* Green for current player highlight */
      }

            body {
        font-family:
            -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          Roboto,
          'Helvetica Neue',
          Arial,
          sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px;
        color: var(--font-color);
        display: flex;
        justify-content: center;
        min-height: 100vh; /* Ensure body takes full height */
      }

      .main-container {
        display: flex;
        width: 100%;
        max-width: 1600px; /* Slightly wider overall width */
        gap: 30px; /* Increased gap */
        border-radius: 15px; /* Rounded corners for the main container */
        overflow: hidden; /* Ensures content stays within rounded corners */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); /* Deeper shadow */
        background-color: #f8f9fa; /* Lighter background for the main content area */
        padding: 20px;
      }

            .controls-area {
        flex-basis: 25%;
        min-width: 280px; /* Slightly wider controls area */
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Slightly softer shadow */
        padding: 25px; /* Increased padding */
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease-in-out; /* Smooth transitions for hover/active states */
      }

      .battle-section {
        flex-basis: 50%;
        display: flex;
        flex-direction: column;
        gap: 25px; /* Increased gap in battle section */
      }

      #battle-arena {
        position: relative;
        width: 100%;
        height: 500px; /* Taller arena */
        background: linear-gradient(
          to bottom right,
          #a2e2b9,
          #5cb85c
        ); /* Greenish gradient background */
        border: 1px solid var(--border-color);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2); /* Inner shadow for depth */
      }

      .coffeemon-display {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
        min-width: 200px; /* Wider for better presentation */
        background-color: rgba(255, 255, 255, 0.85); /* Slightly transparent white background */
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Shadow for lift-off effect */
        backdrop-filter: blur(5px); /* Frosted glass effect */
        transition:
          transform 0.3s ease-out,
          box-shadow 0.3s ease-out; /* Smooth transition */
      }
      .coffeemon-display:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .coffeemon-display img {
        max-width: 180px; /* Larger images */
        max-height: 180px;
        object-fit: contain;
        margin-bottom: 15px;
        border-radius: 5px; /* Slightly rounded image corners */
      }

      .coffeemon-display h4 {
        margin: 0 0 10px 0;
        font-size: 1.4em; /* Larger font for name */
        font-weight: 600;
        color: var(--font-color);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* Subtle text shadow */
      }

      .coffeemon-display .hp-bar-container {
        width: 100%;
        height: 22px; /* Taller HP bar */
        border-radius: 11px; /* More rounded ends */
        background-color: #ccc; /* Lighter background for empty bar */
        border: 1px solid #999;
        overflow: hidden;
      }
      .coffeemon-display .hp-bar {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.85em;
        transition:
          width 0.4s ease-in-out,
          background-color 0.4s ease-in-out;
        border-radius: 11px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* Darker text shadow for readability */
      }

      /* Positioning for the Coffeemons in the arena */
      .player-position {
        bottom: 30px; /* More space from bottom */
        left: 30px; /* More space from left */
      }

      .opponent-position {
        top: 30px; /* More space from top */
        right: 30px; /* More space from right */
      }

            h3,
            h4,
            h5 {
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        margin-top: 0;
        margin-bottom: 15px;
        color: #333; /* Ensure headings are visible */
      }

      #my-controls-area h3 {
        color: var(--player1-color);
      }
      #opponent-controls-area h3 {
        color: var(--player2-color);
      }

      .current-player {
        border-width: 2px;
        box-shadow:
          0 0 20px var(--highlight-glow),
          0 0 30px var(--highlight-glow); /* Stronger glow */
        border-color: var(--highlight-glow) !important;
        transform: scale(1.01); /* Slightly enlarge current player area */
      }

      .actions-container h5 {
        font-size: 1.1em;
        text-transform: uppercase;
        color: #666;
        margin-bottom: 15px;
      }
      .move-card,
      .switch-card {
        border: 1px solid var(--border-color);
        border-radius: 10px; /* More rounded */
        padding: 15px; /* More padding */
        margin-bottom: 12px;
        cursor: pointer;
        transition:
            transform 0.2s,
            box-shadow 0.2s,
          background-color 0.2s;
        background-color: #fdfdfd; /* Off-white background for cards */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .move-card:hover,
      .switch-card:not(.card-disabled):hover {
        transform: translateY(-3px); /* More pronounced lift */
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        background-color: #f0f8ff; /* Light blue on hover */
      }
      .move-card h6 {
        margin: 0 0 8px 0;
        font-size: 1.2em; /* Larger font for move name */
        font-weight: 700; /* Bolder */
      }
      .move-card .power {
        float: right;
        font-weight: bold;
        color: #555; /* Neutral power color */
      }
      #my-actions .move-card h6 {
        color: var(--player1-color);
      }

      .card-disabled {
        cursor: not-allowed !important;
        background-color: #eceff1 !important; /* Lighter disabled background */
        opacity: 0.5; /* More transparent */
        box-shadow: none !important; /* No shadow when disabled */
        transform: none !important; /* No transform when disabled */
      }
      .card-disabled:hover {
        transform: none;
        box-shadow: none;
      }
      .fainted-coffeemon {
        background-color: #dee2e6; /* Greyer when fainted */
        color: #888;
        border-color: #c0c0c0;
      }

      .log-container {
        flex-grow: 1; /* Make log container fill available space */
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
        height: 300px; /* Keep fixed height for consistency */
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .log-area p {
        margin: 6px 0; /* More vertical spacing */
        padding: 8px;
        border-bottom: 1px dashed #f1f3f5; /* Dashed separator */
        font-size: 0.95em;
      }
      .log-area .turn-divider {
        font-weight: bold;
        text-align: center;
        background-color: #4a6c8e; /* Slightly softer dark blue */
        color: white;
        border-radius: 8px; /* More rounded */
        margin-top: 20px; /* More spacing */
        padding: 8px;
        font-size: 1.05em;
      }
      .log-area .event-message {
        font-style: italic;
        color: #555;
      }
      .debug-area {
        margin-top: 20px;
      }
      .debug-area summary {
        background-color: #f1f1f1;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.9em;
        color: #555;
      }
      .debug-area pre {
        background-color: #2d2d2d;
        color: #f1f1f1;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.75em;
        max-height: 200px; /* Smaller debug log by default */
        overflow-y: auto;
        margin-top: 10px;
      }
    </style>
     
  </head>
   
  <body>
       
    <div class="main-container">
      <div id="my-controls-area" class="controls-area">
               
        <h3>Meu Jogador (ID: <span id="my-id"></span>)</h3>
               
        <div id="my-actions" class="actions-container"></div>
             
      </div>

           
      <div class="battle-section">
               
        <div id="battle-arena">
                   
          <div id="player-active-coffeemon-display" class="coffeemon-display player-position"></div>
                   
          <div
            id="opponent-active-coffeemon-display"
            class="coffeemon-display opponent-position"
          ></div>
                 
        </div>
               
        <div class="log-container">
                   
          <h4>Log da Batalha</h4>
                   
          <div class="log-area" id="battle-log"></div>
                   
          <div class="debug-area">
                       
            <details>
                           
              <summary>Ver BattleState Completo</summary>
                           
              <pre id="battle-state-pre"></pre>
                         
            </details>
                     
          </div>
                 
        </div>
             
      </div>

           
      <div id="opponent-controls-area" class="controls-area">
               
        <h3>Oponente (ID: <span id="opponent-id"></span>)</h3>
               
        <div id="opponent-actions" class="actions-container"></div>
             
      </div>
         
    </div>

       
    <script>
      const token = localStorage.getItem('jwt_token');
      const myPlayerId = parseInt(localStorage.getItem('player_id'));
      const battleData = JSON.parse(sessionStorage.getItem('battle_data'));

      if (!token || !battleData || !myPlayerId) {
        alert('Dados da batalha, token ou ID do jogador não encontrados. Redirecionando...');
        window.location.href = 'login.html';
      }

      const battleId = battleData.battleId;
      let battleState = battleData.battleState;
      const battleLog = document.getElementById('battle-log');
      const battleStatePre = document.getElementById('battle-state-pre');

      const socket = io('http://localhost:3000', {
        extraHeaders: { Authorization: `Bearer ${token}` },
      });

      socket.on('connect', () => {
        logMessage(`Conectado. Meu ID: ${myPlayerId}. Entrando na batalha ${battleId}`);
        socket.emit('joinBattle', { battleId });
        updateUI(battleState);
      });

      socket.on('battleUpdate', (data) => {
        logMessage(`<div class="turn-divider">Turno ${data.battleState.turn}</div>`);
        battleState = data.battleState; // Update global battleState
        // Always update UI to reflect current state first, including default/back images

        updateUI(battleState);

        if (battleState.events && battleState.events.length > 0) {
          battleState.events.forEach((event) => {
            logMessage(`<span class="event-message">${event.message}</span>`);

            if (event.type === 'AttackHit') {
              // The player whose Coffeemon was attacked
              const attackedPlayerId =
                event.payload.playerId === battleState.player1Id
                  ? battleState.player2Id
                  : battleState.player1Id;
              const targetCoffeemonName = event.payload.targetName;

              let targetImageElement;
              let originalImageUrl;
              const baseUrl = 'https://gigio42.github.io/Coffeemon/';

              if (attackedPlayerId === myPlayerId) {
                // My Coffeemon was attacked, so its image is in 'player-active-coffeemon-display'
                targetImageElement = document.querySelector(
                  `#player-active-coffeemon-display-image`
                );
                originalImageUrl = `${baseUrl}${targetCoffeemonName}/back.png`; // My Coffeemon's original image type
              } else {
                // Opponent's Coffeemon was attacked, so its image is in 'opponent-active-coffeemon-display'
                targetImageElement = document.querySelector(
                  `#opponent-active-coffeemon-display-image`
                );
                originalImageUrl = `${baseUrl}${targetCoffeemonName}/default.png`; // Opponent's Coffeemon's original image type
              }

              if (targetImageElement) {
                const hurtImageUrl = `${baseUrl}${targetCoffeemonName}/hurt.png`;

                targetImageElement.src = hurtImageUrl;

                setTimeout(() => {
                  targetImageElement.src = originalImageUrl; // Revert to the correct original image
                }, 500); // Display hurt image for 500ms
              }
            }
          });
        }

        if (battleState.battleStatus === BattleStatus.FINISHED) {
          const message = `A batalha terminou! Vencedor: Jogador ${battleState.winnerId}`;
          logMessage(`<strong class="turn-divider">${message}</strong>`);
          alert(message);
        }
      });

      socket.on('battleEnd', (data) => {
        const message = `A batalha terminou! Vencedor: Jogador ${data.winnerId}`;
        logMessage(`<strong class="turn-divider">${message}</strong>`);
        alert(message);
      });

      socket.on('battleError', (error) => logMessage(`<strong>ERRO: ${error.message}</strong>`));

      function logMessage(msg) {
        battleLog.innerHTML = `<p>${msg}</p>` + battleLog.innerHTML; // Adiciona no topo
      }

      function sendAction(actionType, payload) {
        logMessage(`Enviando ação: ${actionType}`);
        socket.emit('battleAction', { battleId, actionType, payload });
      }

      // Global references for the main display elements
      const playerActiveCoffeemonDisplay = document.getElementById(
        'player-active-coffeemon-display'
      );
      const opponentActiveCoffeemonDisplay = document.getElementById(
        'opponent-active-coffeemon-display'
      );

      // Also update references for action areas
      const myActionsContainer = document.getElementById('my-actions');
      const opponentActionsContainer = document.getElementById('opponent-actions');

      function updateUI(state) {
        battleStatePre.textContent = JSON.stringify(state, null, 2); // Determine which player is 'me' and which is 'opponent'

        const myPlayerState = state.player1Id === myPlayerId ? state.player1 : state.player2;
        const opponentPlayerState = state.player1Id === myPlayerId ? state.player2 : state.player1;

        const myPlayerTrueId = state.player1Id === myPlayerId ? state.player1Id : state.player2Id;
        const opponentPlayerTrueId =
          state.player1Id === myPlayerId ? state.player2Id : state.player1Id;

        document.getElementById('my-id').textContent = myPlayerTrueId;
        document.getElementById('opponent-id').textContent = opponentPlayerTrueId; // Set border highlight for current turn

        document.getElementById('my-controls-area').classList.remove('current-player');
        document.getElementById('opponent-controls-area').classList.remove('current-player');

        if (state.currentPlayerId === myPlayerTrueId) {
          document.getElementById('my-controls-area').classList.add('current-player');
        } else {
          document.getElementById('opponent-controls-area').classList.add('current-player');
        } // Update the visual display of active Coffeemons in the arena

        renderCoffeemonDisplay(myPlayerState, 'player-active-coffeemon-display', true, state);
        renderCoffeemonDisplay(
          opponentPlayerState,
          'opponent-active-coffeemon-display',
          false,
          state
        ); // Update action areas

        renderPlayerActions(myPlayerTrueId, myPlayerState, myActionsContainer, true, state);
        renderPlayerActions(
          opponentPlayerTrueId,
          opponentPlayerState,
          opponentActionsContainer,
          false,
          state
        );
      }

      function renderCoffeemonDisplay(playerState, containerId, isMe, fullState) {
        const activeMon = playerState.coffeemons[playerState.activeCoffeemonIndex];
        const coffeemonContainer = document.getElementById(containerId);

        const hpPercentage = (activeMon.currentHp / activeMon.maxHp) * 100;

        const baseUrl = 'https://gigio42.github.io/Coffeemon/';
        const imageType = isMe ? 'back' : 'default'; // 'back' for my Coffeemon, 'default' for opponent's
        const coffeemonNameFormatted = activeMon.name;
        const imageUrl = `${baseUrl}${coffeemonNameFormatted}/${imageType}.png`;
        const defaultImageUrl = 'https://via.placeholder.com/150?text=Image+Not+Found';

        coffeemonContainer.innerHTML = `
            <img id="${containerId}-image" src="${imageUrl}" alt="${activeMon.name}" onerror="this.onerror=null;this.src='${defaultImageUrl}';" />
            <h4>${activeMon.name} ${activeMon.isFainted ? ' (Derrotado)' : ''}</h4>
            <div class="hp-bar-container">
                <div class="hp-bar" style="width: ${hpPercentage}%; background-color: ${isMe ? 'var(--player1-color)' : 'var(--player2-color)'};">${activeMon.currentHp}/${activeMon.maxHp}</div>
            </div>
        `;
      }

      function renderPlayerActions(playerId, playerState, actionsContainer, isMe, fullState) {
        actionsContainer.innerHTML = ''; // Clear previous actions

        const activeMon = playerState.coffeemons[playerState.activeCoffeemonIndex];
        const isMyTurn = playerId === fullState.currentPlayerId;
        const canControl = isMyTurn && isMe;

        if (isMe) {
          const movesContainer = document.createElement('div');
          movesContainer.innerHTML = '<h5>Golpes</h5>';
          activeMon.moves.forEach((move) => {
            const card = document.createElement('div');
            card.className = 'move-card';
            card.innerHTML = `
                    <span class="power">Poder: ${move.power}</span>
                    <h6>${move.name}</h6>
                    <p>${move.description || 'Sem descrição.'}</p>
                `;
            if (canControl && activeMon.canAct) {
              card.onclick = () => sendAction('attack', { moveId: move.id });
            } else {
              card.classList.add('card-disabled');
            }
            movesContainer.appendChild(card);
          });
          actionsContainer.appendChild(movesContainer);
        } else {
          actionsContainer.innerHTML = '<h5>Ações do Oponente</h5><p>Aguardando jogada...</p>';
        }

        const switchContainer = document.createElement('div');
        switchContainer.innerHTML = '<h5>Equipe</h5>';
        playerState.coffeemons.forEach((mon, index) => {
          if (index === playerState.activeCoffeemonIndex) return;

          const card = document.createElement('div');
          card.className = 'switch-card';
          card.innerHTML = `<strong>${mon.name}</strong> (HP: ${mon.currentHp}/${mon.maxHp})`;

          if (mon.isFainted) {
            card.classList.add('fainted-coffeemon', 'card-disabled');
          } else if (isMe) {
            if (canControl) {
              card.onclick = () => sendAction('switch', { newIndex: index });
            } else {
              card.classList.add('card-disabled');
            }
          } else {
            card.classList.add('card-disabled');
          }
          switchContainer.appendChild(card);
        });
        actionsContainer.appendChild(switchContainer);
      }
    </script>
     
  </body>
</html>
