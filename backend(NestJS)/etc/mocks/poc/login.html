<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Teste de Jogo - Login</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
        .container { padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        input { margin-bottom: 10px; padding: 8px; width: 200px; }
        button { padding: 10px; }
        #message { margin-top: 15px; color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Login</h2>
        <form id="loginForm">
            <input type="email" id="email" placeholder="Email" value="Dark@email.com" required><br>
            <input type="password" id="password" placeholder="Senha" value="Jubarte@1234" required><br>
            <button type="submit">Login</button>
        </form>
        <div id="message"></div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = 'Autenticando...';

            try {
                const loginResponse = await fetch('http://localhost:3000/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                const loginData = await loginResponse.json();

                if (!loginData.access_token) throw new Error(loginData.message || 'Falha no login');
                
                const token = loginData.access_token;
                localStorage.setItem('jwt_token', token);
                messageDiv.textContent = 'Usuário autenticado! Buscando dados do jogador...';

                // <<< PASSO ADICIONAL E CRÍTICO >>>
                // Usar o token para buscar os dados do jogador
                const playerResponse = await fetch(`http://localhost:3000/game/players/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!playerResponse.ok) throw new Error('Perfil de jogador não encontrado para este usuário.');

                const playerData = await playerResponse.json();
                
                // Salvar o ID do jogador no localStorage
                localStorage.setItem('player_id', playerData.id);
                
                messageDiv.style.color = 'green';
                messageDiv.textContent = `Login bem-sucedido! Player ID: ${playerData.id}. Redirecionando...`;
                
                window.location.href = 'match.html';

            } catch (error) {
                messageDiv.style.color = 'red';
                messageDiv.textContent = 'Erro: ' + error.message;
                localStorage.clear(); // Limpa tudo em caso de erro
            }
        });
    </script>
</body>
</html>